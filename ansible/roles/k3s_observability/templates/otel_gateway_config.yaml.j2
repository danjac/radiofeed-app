apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-gateway-config
  namespace: default
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      k8s_cluster:
        collection_interval: 60s
        node_conditions_to_report: [Ready, MemoryPressure, DiskPressure]
        allocatable_types_to_report: [cpu, memory]

    processors:
      memory_limiter:
        limit_mib: 256
        spike_limit_mib: 64
        check_interval: 5s
      batch:
        timeout: 10s
      transform/truncate_logs:
        log_statements:
          - context: log
            statements:
              - set(body, Substring(body, 0, 65536)) where IsString(body) and Len(body) > 65536

    exporters:
      prometheusremotewrite:
        endpoint: http://prometheus.default.svc.cluster.local:9090/api/v1/write
        tls:
          insecure: true
      otlphttp/loki:
        endpoint: http://loki.default.svc.cluster.local:3100/otlp
        tls:
          insecure: true
      otlp/tempo:
        endpoint: tempo.default.svc.cluster.local:4317
        tls:
          insecure: true

    service:
      pipelines:
        metrics:
          receivers: [otlp, k8s_cluster]
          processors: [memory_limiter, batch]
          exporters: [prometheusremotewrite]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, transform/truncate_logs, batch]
          exporters: [otlphttp/loki]
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlp/tempo]
