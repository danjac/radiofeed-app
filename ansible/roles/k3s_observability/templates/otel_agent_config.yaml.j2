apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-agent-config
  namespace: default
data:
  config.yaml: |
    receivers:
      hostmetrics:
        collection_interval: 60s
        scrapers:
          cpu: {}
          disk: {}
          filesystem:
            exclude_mount_points:
              mount_points: [/dev, /sys, /proc, /run/k3s/containerd, /var/lib/kubelet]
              match_type: strict
          load: {}
          memory: {}
          network: {}
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        start_at: end
        include_file_path: true
        include_file_name: false
        operators:
          - type: container

    processors:
      memory_limiter:
        limit_mib: 192
        spike_limit_mib: 48
        check_interval: 5s
      batch:
        timeout: 10s
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        filter:
          node_from_env_var: K8S_NODE_NAME
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: connection
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.pod.name
            - k8s.node.name
            - k8s.container.name

    exporters:
      otlphttp/gateway:
        endpoint: http://otel-gateway.default.svc.cluster.local:4318

    service:
      pipelines:
        metrics:
          receivers: [hostmetrics]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/gateway]
        logs:
          receivers: [filelog]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/gateway]
