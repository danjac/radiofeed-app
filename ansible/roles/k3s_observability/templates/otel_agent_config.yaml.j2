apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-agent-config
  namespace: default
data:
  config.yaml: |
    receivers:
      hostmetrics:
        collection_interval: 60s
        scrapers:
          cpu: {}
          disk: {}
          filesystem:
            exclude_mount_points:
              mount_points: [/dev, /sys, /proc, /run/k3s/containerd, /var/lib/kubelet]
              match_type: strict
          load: {}
          memory: {}
          network: {}
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        start_at: end
        include_file_path: true
        include_file_name: false
        operators:
          - type: container

    processors:
      memory_limiter:
        limit_mib: 192
        spike_limit_mib: 48
        check_interval: 5s
      batch:
        timeout: 10s
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        filter:
          node_from_env_var: K8S_NODE_NAME
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: resource_attribute
                name: k8s.pod.name
              - from: resource_attribute
                name: k8s.namespace.name
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: connection
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.pod.name
            - k8s.node.name
            - k8s.container.name
      resource/service_name:
        attributes:
          - key: service.name
            from_attribute: k8s.statefulset.name
            action: upsert
          - key: service.name
            from_attribute: k8s.daemonset.name
            action: upsert
          - key: service.name
            from_attribute: k8s.deployment.name
            action: upsert
      # Fallback: if k8sattributes enrichment failed (service.name still unset or
      # unknown_service), derive a stable service name from the pod name by
      # stripping the two trailing Kubernetes hash segments (-<rs-hash>-<pod-hash>
      # for Deployments, or -<hash> for DaemonSets/StatefulSets).
      transform/service_name_fallback:
        log_statements:
          - context: resource
            statements:
              - >
                set(attributes["service.name"],
                    ExtractPatterns(attributes["k8s.pod.name"],
                        "^(?P<svc>.+?)-[a-z0-9]+-[a-z0-9]+$")["svc"])
                where (attributes["service.name"] == nil
                    or attributes["service.name"] == "unknown_service")
                    and attributes["k8s.pod.name"] != nil
              - >
                set(attributes["service.name"],
                    ExtractPatterns(attributes["k8s.pod.name"],
                        "^(?P<svc>.+?)-[a-z0-9]+$")["svc"])
                where (attributes["service.name"] == nil
                    or attributes["service.name"] == "unknown_service")
                    and attributes["k8s.pod.name"] != nil
      filter/drop_unknown_service:
        error_mode: ignore
        logs:
          log_record:
            - resource.attributes["service.name"] == "unknown_service"
            - resource.attributes["service.name"] == nil

    exporters:
      otlphttp/gateway:
        endpoint: http://otel-gateway.default.svc.cluster.local:4318

    service:
      pipelines:
        metrics:
          receivers: [hostmetrics]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/gateway]
        logs:
          receivers: [filelog]
          processors: [memory_limiter, k8sattributes, resource/service_name, transform/service_name_fallback, filter/drop_unknown_service, batch]
          exporters: [otlphttp/gateway]
