- name: Deploy Kubernetes
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  vars:
    k3s_memory_request_percent: 0.4
    k3s_memory_limit_percent: 0.75
    k3s_cpu_request_percent: 0.35
    k3s_cpu_limit_percent: 0.8
    k3s_cloudflare_cert: "cloudflare.pem"
    k3s_cloudflare_key: "cloudflare.key"
    k3s_cloudflare_certs:
      - "{{ k3s_cloudflare_cert }}"
      - "{{ k3s_cloudflare_key }}"
  block:
    - name: Copy Cloudflare certs to target node
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/certs/{{ item }}"
        dest: "/tmp/{{ item | basename }}"
        mode: "0600"
      loop: "{{ k3s_cloudflare_certs }}"
    - name: Create Kubernetes TLS Secret
      ansible.builtin.shell: |
        set -o pipefail
        kubectl create secret tls cloudflare-origin-cert \
            --cert=/tmp/{{ k3s_cloudflare_cert }} \
            --key=/tmp/{{ k3s_cloudflare_key }} \
            -n default --dry-run=client -o yaml | kubectl apply -f -
      args:
        executable: /bin/bash
        creates: "/tmp/cloudflare-origin-cert.created"
    - name: Remove certs from /tmp after secret is created
      ansible.builtin.file:
        path: "/tmp/{{ item }}"
        state: absent
      loop: "{{ k3s_cloudflare_certs }}"
    - name: Label the nodes
      ansible.builtin.shell: |
        kubectl label nodes {{ hostvars[item].hostname }} role={{ hostvars[item].role }} --overwrite
      loop: "{{ groups['all'] }}"
      register: k3s_kubectl_label_result
      changed_when: "'labeled' in k3s_kubectl_label_result.stdout or 'changed' in k3s_kubectl_label_result.stdout"
    - name: Force CoreDNS to run on the server node
      ansible.builtin.shell: |
        kubectl patch deployment coredns -n kube-system \
          --type='json' \
          -p='[{"op": "add", "path": "/spec/template/spec/nodeSelector", "value": {"role": "server"}}]'
      register: k3s_kubectl_patch_result
      changed_when: "'patched' in k3s_kubectl_patch_result.stdout"
    - name: Restart CoreDNS to apply changes
      ansible.builtin.shell: |
        kubectl rollout restart deployment/coredns -n kube-system
      register: k3s_kubectl_restart_result
      changed_when: "'restarted' in k3s_kubectl_restart_result.stdout"
    - name: Force metrics-server to run on the server node
      ansible.builtin.shell: |
        kubectl patch deployment metrics-server -n kube-system \
          --type='json' \
          -p='[{"op": "add", "path": "/spec/template/spec/nodeSelector", "value": {"role": "server"}}]'
      register: k3s_kubectl_patch_result
      changed_when: "'patched' in k3s_kubectl_patch_result.stdout"
    - name: Restart metrics-server to apply changes
      ansible.builtin.shell: |
        kubectl rollout restart deployment/metrics-server -n kube-system
      register: k3s_kubectl_restart_result
      changed_when: "'restarted' in k3s_kubectl_restart_result.stdout"
    - name: Force Traefik to run on the server node
      ansible.builtin.shell: |
        kubectl patch deployment traefik -n kube-system \
          --type='json' \
          -p='[{"op": "add", "path": "/spec/template/spec/nodeSelector", "value": {"role": "server"}}]'
      register: k3s_kubectl_patch_result
      changed_when: "'patched' in k3s_kubectl_patch_result.stdout"
    - name: Restart Traefik to apply changes
      ansible.builtin.shell: |
        kubectl rollout restart deployment/traefik -n kube-system
      register: k3s_kubectl_restart_result
      changed_when: "'restarted' in k3s_kubectl_restart_result.stdout"
    - name: Get the current image of running django-app pod
      ansible.builtin.shell: |
        kubectl get pods -l app=django-app -o jsonpath='{.items[0].spec.containers[0].image}' -n default || echo ""
      register: k3s_current_image
      changed_when: false
      failed_when: false
    - name: Set default image if current image is empty
      ansible.builtin.set_fact:
        k3s_image: "{{ k3s_current_image.stdout if k3s_current_image.stdout | length > 0 else k3s_docker_image }}"
      changed_when: false
    - name: Create a temporary directory
      ansible.builtin.tempfile:
        state: directory
      register: k3s_manifests_dir
    - name: Calculate total resources
      ansible.builtin.set_fact:
        k3s_total_memory_mb: "{{ ansible_memtotal_mb }}"
        k3s_total_cpu_millicores: "{{ ansible_processor_vcpus * 1000 }}"
    - name: Calculate resource requests/limits
      ansible.builtin.set_fact:
        k3s_mem_request: "{{ (k3s_total_memory_mb | int * k3s_memory_request_percent) | int }}Mi"
        k3s_mem_limit: "{{ (k3s_total_memory_mb | int * k3s_memory_limit_percent) | int }}Mi"
        k3s_cpu_request: "{{ (k3s_total_cpu_millicores | int * k3s_cpu_request_percent) | int }}m"
        k3s_cpu_limit: "{{ (k3s_total_cpu_millicores | int * k3s_cpu_limit_percent) | int }}m"
    - name: Render Kubernetes manifests
      vars:
        k3s_database_url: "postgresql://postgres:{{ k3s_postgres.password }}@postgres.default.svc.cluster.local:5432/postgres"
        k3s_redis_url: "redis://redis.default.svc.cluster.local:6379/0"
        k3s_manage_cmd: "python ./manage.py"
        k3s_num_webapps: "{{ groups['agents'] | map('extract', hostvars, 'role') | select('equalto', 'webapp') | length }}"
        k3s_postgres_major_version: "{{ k3s_postgres.image.split(':')[1].split('.')[0] }}"
      ansible.builtin.template:
        src: "{{ item }}.yaml.j2"
        dest: "{{ k3s_manifests_dir.path + '/' + item + '.yaml' }}"
        mode: "0644"
      loop:
        - configmap
        - secrets
        - postgres_pv
        - postgres_pvc
        - postgres_statefulset
        - postgres_service
        - redis_deployment
        - redis_service
        - django_deployment
        - django_service
        - ingress_route
    - name: Apply Kubernetes manifests using ApplySet
      ansible.builtin.shell: |
        kubectl apply -f {{ k3s_manifests_dir.path }} --prune --applyset=app-deployment --namespace=default
      environment:
        KUBECTL_APPLYSET: "true"
      register: k3s_kubectl_apply_result
      changed_when: >
        'created' in k3s_kubectl_apply_result.stdout or 'configured' in k3s_kubectl_apply_result.stdout or 'deleted' in k3s_kubectl_apply_result.stdout

    - name: Delete manifests dir
      ansible.builtin.file:
        path: "{{ k3s_manifests_dir.path }}"
        state: absent
    - name: Restart statefulsets
      ansible.builtin.shell: |
        for statefulset in $(kubectl get statefulsets -n default -o jsonpath='{.items[*].metadata.name}'); do
          kubectl rollout restart statefulset/$statefulset -n default
        done
      register: k3s_kubectl_restart_result
      changed_when: "'restarted' in k3s_kubectl_restart_result.stdout"
    - name: Restart deployments
      ansible.builtin.shell: |
        for deployment in $(kubectl get deployments -n default -o jsonpath='{.items[*].metadata.name}'); do
          kubectl rollout restart deployment/$deployment -n default
        done
      register: k3s_kubectl_restart_result
      changed_when: "'restarted' in k3s_kubectl_restart_result.stdout"
