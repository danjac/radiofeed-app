- name: Deploy Kubernetes
  environment:
      KUBECONFIG: "{{ kubeconfig }}"
  block:
      - name: Get the current image of running django-app pod
        ansible.builtin.shell: |
            kubectl get pods -l app=django-app -o jsonpath='{.items[0].spec.containers[0].image}' -n default
        register: k3s_crons_current_image
        changed_when: false
        ignore_errors: true

      - name: Set default image if current image is empty
        ansible.builtin.set_fact:
            k3s_crons_image: "{{ k3s_crons_current_image.stdout if k3s_crons_current_image.stdout | length > 0 else k3s_docker_image }}"
        changed_when: false
        when: k3s_crons_current_image is defined and k3s_crons_current_image.stdout is defined

      - name: Create a temporary directory
        ansible.builtin.tempfile:
            state: directory
        register: k3s_crons_manifests_dir

      - name: Render Kubernetes manifests
        vars:
            manage_cmd: "./manage.sh"
        ansible.builtin.template:
            src: "django_cronjobs.yaml.j2"
            dest: "{{ k3s_crons_manifests_dir.path + '/' + 'django_cronjobs.yaml' }}"
            mode: "0644"

      - name: Delete all cronjobs
        ansible.builtin.shell: |
            kubectl delete cronjob -l app=django-cronjob -n default
        changed_when: true

      - name: Apply Kubernetes manifests using ApplySet
        ansible.builtin.shell: |
            kubectl apply -f {{ k3s_crons_manifests_dir.path }} --namespace=default
        environment:
            KUBECTL_APPLYSET: "true"
        changed_when: true

      - name: Delete manifests dir
        ansible.builtin.file:
            path: "{{ k3s_crons_manifests_dir.path }}"
            state: absent
